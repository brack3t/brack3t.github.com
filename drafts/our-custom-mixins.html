<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>brack3t</title>
    <meta name="description" content="">
    <meta name="author" content="Brack3t, aka Kenneth Love and Chris Jones">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href=".././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="brack3t ATOM Feed">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="http://fonts.googleapis.com/css?family=Exo:200,300,500,700,900,200italic,300italic,500italic,700italic,900italic" rel="stylesheet">
    <link href=".././brack3t-theme/assets/bootstrap/css/bootstrap.css" rel="stylesheet">
    <link href=".././brack3t-theme/assets/github.css" rel="stylesheet">
    <link href=".././brack3t-theme/assets/bootstrap/css/brack3t.css" rel="stylesheet">
    <script>
    var _gaq = _gaq || [];
    _gaq.push(["_setAccount", "UA-4642386-4"]);
    _gaq.push(["_trackPageview"]);

    (function() {
        var ga = document.createElement("script"); ga.type = "text/javascript"; ga.async = true;
        ga.src = ("https:" == document.location.protocol ? "https://ssl" : "http://www") + ".google-analytics.com/ga.js";
        var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
	
<script type="text/javascript">
	var disqus_identifier = "our-custom-mixins.html";
	(function() {
		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		dsq.src = 'http://brack3t.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>

  </head>

  <body>

    <div class="container">
        <div class="row-fluid">
            <div class="span5">
                <header id="logo" role="banner">
                    <h1><a href="/">Brack3t</a></h1>
                    <h6>Two guys... and Python.</h6>
                </header>
            </div>
            <aside class="span2" id="sidebar" role="complementary">
                <nav>
                    <ul class="unstyled">
                        
                        
                            
                            <li><a href=".././pages/about-us.html">About</a></li>
                            
                        
                        <li><a href=".././pages/projects.html">Projects</a></li>
                        <li><a href=".././archives.html">Archives</a></li>
                        <li><a href=".././tags.html">Tags</a></li>
                    </ul>
                </nav>
            </aside>
        </div>

        <div class="row-fluid">
            <div class="span7" id="main" role="main">
                
                
    <article>
        <header>
            <h1><span class="slabtext">Our Custom Mixins</span></h1>
            <h6><span class="permalink">Published: <a  href=".././our-custom-mixins.html">03-01-2012</a></span>
<span class="author">by <strong>Chris</strong></span>
<span class="tags">tags: <a href=".././tag/django.html">django</a> <a href=".././tag/CBVs.html">CBVs</a> </span>

</h6>
        </header>
        <p>Let's just start out and say it, <tt class="docutils literal">Class Based Views</tt>. Ooohhhh. Unfortunately the topic of class based views is
thought of as somewhat of a dark art in the Django community. It doesn't help that the documentation is still very
lacking but I find a lot of people, especially on Reddit, that refuse to use them. For whatever reason, it's a hard
pill for some to swallow.</p>
<p>Before Djangocon 2011, we started playing with class based views. At first they seem like a nightmare and without
decent docs, you can get frustrated really fast. Skip forward to today and I can't imagine writing old function based
views again. Some argue that the <tt class="docutils literal">generic views</tt> are only for generic applications and that somehow, their work is far too
custom and complex to be handled in a generic class based view. Based on my experience, they would be mostly wrong. I'll
leave that mostly in there for the 1-2% that that might apply to.</p>
<p>We plan on covering generic class based views extensively with <a class="reference external" href="http://gettingstartedwithdjango.com">GSWD</a>. Today, I'd like to share some mixins we
have cooked up on a rather large client project that have helped us out tremendiously.</p>
<p>For those of you not familiar with decorating class based views, check out the Django documentation on
<a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/class-based-views/#decorating-the-class">decorating the class</a>.</p>
<div class="section" id="loginrequiredmixin">
<h2>LoginRequiredMixin</h2>
<div class="highlight"><pre><span class="x">class LoginRequiredMixin(object):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    View mixin which verifies that the user has authenticated.</span>

<span class="x">    NOTE:</span>
<span class="x">        This should be the left-most mixin of a view.</span>
<span class="x">    &quot;&quot;&quot;</span>

<span class="x">    @method_decorator(login_required)</span>
<span class="x">    def dispatch(self, *args, **kwargs):</span>
<span class="x">        return super(LoginRequiredMixin, self).dispatch(*args, **kwargs)</span>
</pre></div>
<p>This mixin is rather simple and is generally the first inherited class in any of our views. If we don't have an authenticated user
there's no need to go any further. If you've used Django before you are probably familiar with the <tt class="docutils literal">login_required</tt> decorator.
All we are doing here is requiring a user to be authenticated to be able to get to this view.</p>
<p>While this doesn't look like much, it frees us up from having to manually overload the dispatch method on every single view that
requires a user to be authenticated. If that's all that is needed on this view, we just saved 3 lines of code. Example usage below.</p>
<div class="highlight"><pre><span class="x">from django.views.generic import TemplateView</span>

<span class="x">from myapp.mixins import LoginRequiredMixin</span>


<span class="x">class SomeSecretView(LoginRequiredMixin, TemplateView):</span>
<span class="x">    template_name = &quot;path/to/template.html&quot;</span>

<span class="x">    def get(self, request):</span>
<span class="x">        return self.render_to_response({})</span>
</pre></div>
</div>
<div class="section" id="permissionrequiredmixin">
<h2>PermissionRequiredMixin</h2>
<div class="highlight"><pre><span class="x">class PermissionRequiredMixin(object):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    View mixin which verifies that the logged in user has the specified</span>
<span class="x">    permission.</span>

<span class="x">    Class Settings</span>
<span class="x">    `permission_required` - the permission to check for.</span>
<span class="x">    `login_url` - the login url of site</span>
<span class="x">    `redirect_field_name` - defaults to &quot;next&quot;</span>
<span class="x">    `raise_exception` - defaults to False - raise 403 if set to True</span>

<span class="x">    Example Usage</span>

<span class="x">        class SomeView(PermissionRequiredMixin, ListView):</span>
<span class="x">            ...</span>
<span class="x">            # required</span>
<span class="x">            permission_required = &quot;app.permission&quot;</span>

<span class="x">            # optional</span>
<span class="x">            login_url = &quot;/signup/&quot;</span>
<span class="x">            redirect_field_name = &quot;hollaback&quot;</span>
<span class="x">            raise_exception = True</span>
<span class="x">            ...</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    login_url = settings.LOGIN_URL</span>
<span class="x">    permission_required = None</span>
<span class="x">    raise_exception = False</span>
<span class="x">    redirect_field_name = REDIRECT_FIELD_NAME</span>

<span class="x">    def dispatch(self, request, *args, **kwargs):</span>
<span class="x">        original_return_value = super(PermissionRequiredMixin, self).dispatch(</span>
<span class="x">            request, *args, **kwargs)</span>

<span class="x">        # Verify class settings</span>
<span class="x">        if self.permission_required == None or len(</span>
<span class="x">            self.permission_required.split(&quot;.&quot;)) != 2:</span>
<span class="x">            raise ImproperlyConfigured(&quot;&#39;PermissionRequiredMixin&#39; requires &quot;</span>
<span class="x">                &quot;&#39;permission_required&#39; attribute to be set.&quot;)</span>

<span class="x">        has_permission = request.user.has_perm(self.permission_required)</span>

<span class="x">        if not has_permission:</span>
<span class="x">            if self.raise_exception:</span>
<span class="x">                return HttpResponseForbidden()</span>
<span class="x">            else:</span>
<span class="x">                path = urlquote(request.get_full_path())</span>
<span class="x">                tup = self.login_url, self.redirect_field_name, path</span>
<span class="x">                return HttpResponseRedirect(&quot;%s?%s=%s&quot; % tup)</span>

<span class="x">        return original_return_value</span>
</pre></div>
<p>This mixin was actually written, I believe, by <a class="reference external" href="https://github.com/danols">Daniel Sokolowski</a> (<a class="reference external" href="https://github.com/lukaszb/django-guardian/issues/48">code here</a>).</p>
<p>The permission required mixin has been very handy for our client's custom CMS. Again, rather than overloading the
dispatch method manually on every view that needs to check for the existence of a permission, we inherit this class
and set the <tt class="docutils literal">permission_required</tt> class attribute on our view. If you don't specify <tt class="docutils literal">permission_required</tt> on
your view, an <tt class="docutils literal">ImproperlyConfigured</tt> exception is raised reminding you that you haven't set it.</p>
<p>The one limitation of this mixin is that it can <strong>only</strong> accept a single permission. It would need to be modified to
handle more than one. We haven't needed that yet, so this has worked out well for us.</p>
<p>In our normal use case for this mixin, <tt class="docutils literal">LoginRequiredMixin</tt> comes first, then the <tt class="docutils literal">PermissionRequiredMixin</tt>. If we
don't have an authenticated user, there is no sense in checking for any permissions.</p>
<blockquote>
<span class="label label-info">note</span> If you are using Django's built in auth system, <tt class="docutils literal">super users</tt> automatically have all permissions in your system.</blockquote>
</div>
<div class="section" id="superuserrequiredmixin">
<h2>SuperuserRequiredMixin</h2>
<div class="highlight"><pre><span class="x">class SuperuserRequiredMixin(object):</span>
<span class="x">    login_url = settings.LOGIN_URL</span>
<span class="x">    raise_exception = False</span>
<span class="x">    redirect_field_name = REDIRECT_FIELD_NAME</span>

<span class="x">    def dispatch(self, request, *args, **kwargs):</span>
<span class="x">        original_return_value = super(</span>
<span class="x">            SuperuserRequiredMixin, self).dispatch(</span>
<span class="x">            request, *args, **kwargs)</span>

<span class="x">        if not request.user.is_superuser:</span>
<span class="x">            if self.raise_exception:</span>
<span class="x">                return HttpResponseForbidden()</span>
<span class="x">            else:</span>
<span class="x">                path = urlquote(request.get_full_path())</span>
<span class="x">                tup = self.login_url, self.redirect_field_name, path</span>
<span class="x">                return HttpResponseRedirect(&quot;%s?%s=%s&quot; % tup)</span>

<span class="x">        return original_return_value</span>
</pre></div>
<p>Another permission based mixin. This is specifically for requiring a user to be a super user. Comes in handy for tools that only privilaged
users should have access to.</p>
</div>
<div class="section" id="userformkwargsmixin">
<h2>UserFormKwargsMixin</h2>
<div class="highlight"><pre><span class="x">class UserFormKwargsMixin(object):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    CBV mixin which puts the user from the request into the form kwargs.</span>
<span class="x">    Note: Using this mixin requires you to pop the `user` kwarg</span>
<span class="x">    out of the dict in the super of your form&#39;s `__init__`.</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    def get_form_kwargs(self, **kwargs):</span>
<span class="x">        kwargs = super(UserFormKwargsMixin, self).get_form_kwargs(**kwargs)</span>
<span class="x">        kwargs.update({&quot;user&quot;: self.request.user})</span>
<span class="x">        return kwargs</span>
</pre></div>
<p>In our clients CMS, we have a lot of form based views that require a user to be passed in for permission based form tools. For example,
only super users can delete or disable certain objects. To custom tailor the form for users, we have to pass that user instance into the form
and based on their permission level, change certain fields or add specific options within the forms <tt class="docutils literal">__init__</tt> method.</p>
<p>This mixin automates the process of overloading the <tt class="docutils literal">get_form_kwargs</tt> method and stuffs the user instance into the form kwargs. We can then
pop the user off in the form and do with it what we need. <strong>Always</strong> remember to pop the user from the kwargs before calling <tt class="docutils literal">super</tt> on your
form, otherwise the form gets an unexpected kwarg and everything blows up. Example usage:</p>
<div class="highlight"><pre><span class="x">from django.views.generic import CreateView</span>

<span class="x">from myapp.mixins import LoginRequiredMixin, UserFormKwargsMixin</span>


<span class="x">class SomeForm(forms.ModelForm):</span>
<span class="x">    class Meta:</span>
<span class="x">        model = SomeModel</span>

<span class="x">    def __init__(self, *args, **kwargs):</span>
<span class="x">        self.user = kwargs.pop(&quot;user&quot;, None)</span>
<span class="x">        super(SomeForm, self).__init__(*args, **kwargs)</span>

<span class="x">        if self.user.is_superuser:</span>
<span class="x">            ...</span>
<span class="x">            Allow them to do something awesome.</span>
<span class="x">            ...</span>


<span class="x">class SomeSecretView(LoginRequiredMixin, UserFormKwargsMixin,</span>
<span class="x">    TemplateView):</span>

<span class="x">    form_class = SomeForm</span>
<span class="x">    model = SomeModel</span>
<span class="x">    template_name = &quot;path/to/template.html&quot;</span>
</pre></div>
</div>
<div class="section" id="userkwargmodelformmixin">
<h2>UserKwargModelFormMixin</h2>
<p><tt class="docutils literal">Show usage of the new form mixin</tt></p>
</div>
<div class="section" id="successurlredirectlistmixin">
<h2>SuccessURLRedirectListMixin</h2>
<div class="highlight"><pre><span class="x">class SuccessURLRedirectListMixin(object):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    Simple CBV mixin which sets the success url to the list view of</span>
<span class="x">    a given app. Set success_list_url as a class attribute of your</span>
<span class="x">    CBV and don&#39;t worry about overloading the get_success_url.</span>

<span class="x">    This is only to be used for redirecting to a list page. If you need</span>
<span class="x">    to reverse the url with kwargs, this is not the mixin to use.</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    success_list_url = None</span>

<span class="x">    def get_success_url(self):</span>
<span class="x">        return reverse(self.success_list_url)</span>
</pre></div>
</div>
<div class="section" id="setheadlinemixin">
<h2>SetHeadlineMixin</h2>
<div class="highlight"><pre><span class="x">class SetHeadlineMixin(object):</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    Mixin allows you to set a static headline through a static property on the</span>
<span class="x">    class or programmatically by overloading the get_headline method.</span>
<span class="x">    &quot;&quot;&quot;</span>
<span class="x">    headline = None</span>

<span class="x">    def get_context_data(self, **kwargs):</span>
<span class="x">        kwargs = super(SetHeadlineMixin, self).get_context_data(**kwargs)</span>
<span class="x">        kwargs.update({&quot;headline&quot;: self.get_headline()})</span>
<span class="x">        return kwargs</span>

<span class="x">    def get_headline(self):</span>
<span class="x">        if self.headline is None:</span>
<span class="x">            raise ImproperlyConfigured(u&quot;%(cls)s is missing a headline. Define &quot;</span>
<span class="x">                u&quot;%(cls)s.headline, or override &quot;</span>
<span class="x">                u&quot;%(cls)s.get_headline().&quot; % {&quot;cls&quot;: self.__class__.__name__</span>
<span class="x">            })</span>
<span class="x">        return self.headline</span>
</pre></div>
</div>

    </article>

	
	<section>
		<header>
			<h1>Comments</h1>
		</header>
		<div id="disqus_thread"></div>
	</section>
	


            </div>
        </div>
        <footer><p>&copy; Brack3t. All rights reserved. <a href=".././feeds/all.atom.xml">ATOM feed</a></p></footer>
    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->

    <!-- Placed at the end of the document so the pages load faster -->
    <script src=".././brack3t-theme/assets/jquery-1.7.1.min.js"></script>
    <script src=".././brack3t-theme/assets/jquery.slabtext.min.js"></script>
    <script src=".././brack3t-theme/assets/jquery.fittext.js"></script>
    <script src=".././brack3t-theme/assets/highlight.pack.js"></script>
    <script>
        $(function() {
            $(".slabtext").slabText();
            $(".fittext").fitText(0.8);
            $(".highlight pre").each(function(i, e) {hljs.highlightBlock(e, "    ")});
        });
    </script>
  </body>
</html>
